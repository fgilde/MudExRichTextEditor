class MudExRichTextEdit{elementRef;options;dotnet;quill;constructor(e,t,i){this.elementRef=e,this.dotnet=t,this.create(this.options=i)}create(e){var t={debug:e.debugLevel,modules:{toolbar:e.toolBar},placeholder:e.placeholder,readOnly:e.readOnly,theme:e.theme};if(e.quillElement||this.elementRef){if(e.modules&&e.modules.length&&e.modules.forEach(i=>{const n=i.jsReference||window,o=i.jsConfigFunction&&n[i.jsConfigFunction]?n[i.jsConfigFunction](t,e,e.quillElement||this.elementRef):i.options;o&&(t.modules={...t.modules,...o})}),this.quill=new Quill(e.quillElement||this.elementRef,t),this.__quill=this.__quill||this.quill,e.quillElement.__quill=this.__quill,e.quillElement.quill=this.quill,e.quillElement.mudRichTextEdit=this,e.beforeUpload&&!e.defaultToolHandlerNames?.includes("image")&&this.quill.getModule("toolbar").addHandler("image",()=>{const e=document.createElement("input");e.setAttribute("type","file"),e.setAttribute("accept","image/*"),e.click(),e.onchange=t=>{const i=e.files[0];if(i){const e=new FileReader;e.onload=t=>{const n=e.result,o={data:new Uint8Array(n),fileName:i.name,extension:i.name.includes(".")?i.name.split(".").slice(-1)[0]:"",contentType:i.type,path:"",size:i.size};this.dotnet.invokeMethodAsync("UploadImage",o).then(e=>{const t=this.quill.getSelection();this.quill.insertEmbed(t.index,"image",e)}).catch(e=>console.error(e))},e.readAsArrayBuffer(i)}}}),e.beforeUpload&&this.quill.root.addEventListener("paste",e=>{if(e.clipboardData&&e.clipboardData.files&&e.clipboardData.files.length>0){const t=e.clipboardData.files[0];if(t){e.preventDefault(),e.stopImmediatePropagation();const i=new FileReader;i.onload=()=>{const e=i.result,n={data:new Uint8Array(e),fileName:t.name,extension:t.name.includes(".")?t.name.split(".").pop():"",contentType:t.type,path:"",size:t.size};this.dotnet.invokeMethodAsync("UploadImage",n).then(e=>{const t=this.quill.getSelection()||{index:this.quill.getLength()};-1!==n.contentType.indexOf("image")?this.quill.insertEmbed(t.index,"image",e):(this.quill.insertText(t.index,n.fileName,"user"),this.quill.setSelection(t.index,n.fileName.length),this.quill.theme.tooltip.edit("link",e),this.quill.theme.tooltip.save())}).catch(e=>console.error(e))},i.readAsArrayBuffer(t)}}},!0),e.defaultToolHandlerNames&&e.defaultToolHandlerNames.forEach(e=>{this.quill.getModule("toolbar").addHandler(e,()=>this.dotnet.invokeMethodAsync("DelegateHandler",e,[...arguments].slice(1)))}),this.quill.container.addEventListener("mouseleave",()=>{this.dotnet.invokeMethodAsync("OnMouseLeave")}),this.quill.on("text-change",(e,t,i)=>{var n=this.quill.root.innerHTML;this.dotnet.invokeMethodAsync("OnContentChanged",n,i)}),this.quill.on("selection-change",(e,t,i)=>{var n=this.quill.root.innerHTML;null===e&&null!==t?this.dotnet.invokeMethodAsync("OnBlur",n,i):null!==e&&null===t&&this.dotnet.invokeMethodAsync("OnFocus",n,i)}),this.quill&&this.quill.root&&this.quill.root.parentNode){window.addEventListener("resize",this.adjustTooltipPosition.bind(this)),this.interval=setInterval(this.adjustTooltipPosition.bind(this),100);new ResizeObserver(e=>{if(e.length>0){var t=e[0].target.getBoundingClientRect().height;this.dotnet.invokeMethodAsync("OnHeightChanged",t)}}).observe(this.quill.root.parentNode);const e=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&e.intersectionRatio>0&&this.quill&&this.quill.root&&(this.quill.root.style.height="",setTimeout(()=>{if(this.quill&&this.quill.root&&this.quill.root.parentNode){const e=this.quill.root.parentNode.getBoundingClientRect().height;this.dotnet.invokeMethodAsync("OnHeightChanged",e)}},50))})},{threshold:[0,.1]});this.intersectionObserver=e,e.observe(this.quill.root.parentNode)}this.dotnet.invokeMethodAsync("OnCreated")}}stopRecording(){this.recognition&&(this.recognition.stop(),this.recognition=null)}startRecording(e){if("webkitSpeechRecognition"in window){this.recognition=new webkitSpeechRecognition,e&&(this.recognition.lang=e),this.recognition.continuous=!0,this.recognition.interimResults=!0;let t=!1;return this.recognition.onresult=e=>{let i="";for(let n=e.resultIndex;n<e.results.length;++n)e.results[n].isFinal?(t=!0,i+=e.results[n][0].transcript+"\n"):i+=e.results[n][0].transcript;let n=this.quill.getSelection()?this.quill.getSelection().index:this.quill.getLength();t&&(this.quill.insertText(n,i,"user"),this.quill.setSelection(n+i.length),t=!1)},this.recognition.start(),!0}return!1}adjustTooltipPosition(){var e=window.getComputedStyle(this.quill.root.parentNode).getPropertyValue("resize");e&&"none"!==e&&(this.adjustPos(this.elementRef.querySelector(".ql-tooltip")),this.adjustPos(this.elementRef.querySelector(".ql-cell-properties-form")),this.adjustPos(this.elementRef.querySelector(".ql-table-properties-form")))}adjustPos(e){if(!e)return;if(e.dataset.mouseIsDown)return;const t=window.getComputedStyle(e).position;if("absolute"===t||"fixed"===t){const t=e.parentElement;if(t){const i=t.getBoundingClientRect(),n=e.getBoundingClientRect();(n.left<i.left||n.top<i.top||n.right>i.right||n.bottom>i.bottom)&&(e.style.left="0")}}e.dataset.dragAttached||(e.dataset.dragAttached="true",e.addEventListener("mousedown",function(t){const i=window.getComputedStyle(e).resize;let n=!1;if("none"!==i&&(("both"===i||"horizontal"===i)&&t.offsetX>e.offsetWidth-10&&(n=!0),("both"===i||"vertical"===i)&&t.offsetY>e.offsetHeight-10&&(n=!0)),n)return;e.dataset.mouseIsDown=!0,t.preventDefault();const o=t.clientX,l=t.clientY,s=parseInt(window.getComputedStyle(e).left,10)||0,r=parseInt(window.getComputedStyle(e).top,10)||0,d=o-s,a=l-r;function u(t){let i=t.clientX-d,n=t.clientY-a;if(e.parentElement){const t=e.parentElement.getBoundingClientRect(),o=e.getBoundingClientRect(),l=o.width,s=o.height;i<0&&(i=0),n<0&&(n=0),i+l>t.width&&(i=t.width-l),n+s>t.height&&(n=t.height-s)}e.style.left=i+"px",e.style.top=n+"px"}document.addEventListener("mousemove",u),document.addEventListener("mouseup",function t(){e.dataset.mouseIsDown=!1,document.removeEventListener("mousemove",u),document.removeEventListener("mouseup",t)})}))}insertImage(e){var t=Quill.import("delta"),i=0;return null!==this.quill.getSelection()&&(i=this.quill.getSelection().index),this.quill.updateContents((new t).retain(i).insert({image:e},{alt:e}))}insertMarkup(e){let t=this.quill.getSelection()?.index??this.quill.getLength();this.quill.clipboard.dangerouslyPasteHTML(t,e),this.quill.setSelection(t+e.length)}dispose(){clearInterval(this.interval),this.stopRecording(),this.intersectionObserver&&(this.intersectionObserver.disconnect(),this.intersectionObserver=null)}}window.MudExRichTextEdit=MudExRichTextEdit;export function initializeMudExRichTextEdit(e,t,i){return new MudExRichTextEdit(e,t,i)}